<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Tracking for Field Staff</title>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3Fm6yUsQd2O-yD3HhccHIvGUAZKiP7u0",
            authDomain: "trace-the-path.firebaseapp.com",
            projectId: "trace-the-path",
            storageBucket: "trace-the-path.firebasestorage.app",
            messagingSenderId: "818537545903",
            appId: "1:818537545903:web:50da1e17e4c3b457fed45a",
            measurementId: "G-5VP540RKTP"
        };

        // Initialize Firebase with error handling
        try {
            console.log('Initializing Firebase for tracking page...');
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // Make Firebase available globally
            window.firebaseDB = db;
            window.firebaseModules = {
                collection,
                query,
                where,
                getDocs,
                doc,
                getDoc
            };
            
            console.log('Firebase initialized successfully for tracking page');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            
            // Handle OAuth domain errors gracefully
            if (error.message && error.message.includes('domain') && error.message.includes('authorized')) {
                console.warn('OAuth Domain Issue - Add', window.location.hostname, 'to Firebase authorized domains');
                console.log('Tracking will continue with URL parameter data instead of Firebase lookup');
            }
        }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            overflow: hidden; /* No scrollbars on desktop */
            height: 100vh; /* Fixed viewport height for desktop */
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }
        
        .header h1 {
            margin: 0;
            font-size: 3rem;
            font-weight: bold;
            color: #3498db;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .header p {
            margin: 5px 0 0 0;
            font-size: 1.2rem;
            color: #ecf0f1;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 15px 20px;
            overflow: hidden;
        }
        
        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px 20px 30px 20px; /* Added bottom padding */
            color: #333;
            overflow: hidden; /* Hide scrollbars */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            flex: 1; /* Same as map - takes available space for perfect centering */
            max-width: 350px; /* Maintain sidebar width while allowing flex behavior */
        }
        
        .staff-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .staff-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 15px;
        }
        
        .staff-details h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .staff-details p {
            margin: 2px 0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }z
        
        .status-online {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #2ecc71;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .timeline {
            flex: 1;
            overflow-y: auto; /* Scrollbar only when content overflows */
            overflow-x: hidden;
            padding-right: 5px; /* Space for scrollbar */
            min-height: 0; /* Allow flex item to shrink below content size */
        }
        
        .timeline-item {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(248, 249, 250, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .timeline-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .timeline-marker.start { background: #2ecc71; }
        .timeline-marker.checkpoint { background: #3498db; }
        .timeline-marker.end { background: #e74c3c; }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-content h4 {
            margin: 0 0 3px 0;
            color: #1a1a1a;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .timeline-content p {
            margin: 1px 0;
            color: #444444;
            font-size: 0.75rem;
            line-height: 1.3;
        }
        
        #map {
            flex: 1;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .recenter-button {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            font-size: 18px;
        }
        
        .recenter-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, #2980b9, #27ae60);
        }
        
        .recenter-button:active {
            transform: scale(0.95);
        }
        
        .recenter-button::before {
            content: 'üéØ';
            font-size: 20px;
        }
        
        .add-place-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            font-size: 28px;
            font-weight: bold;
        }
        
        .add-place-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, #27ae60, #229954);
        }
        
        .add-place-button:active {
            transform: scale(0.95);
        }
        
        .add-place-button::before {
            content: '+';
            font-size: 32px;
            line-height: 1;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        /* Responsive Design - Mobile First */
        
        /* Tablet Styles (768px - 1024px) */
        @media screen and (max-width: 1024px) {
            .sidebar {
                width: 300px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .main-container {
                gap: 15px;
                padding: 15px;
            }
        }
        
        /* Mobile Styles (max-width: 768px) */
        @media screen and (max-width: 768px) {
            body {
                overflow-y: auto; /* Enable vertical scrollbar on mobile */
                min-height: 100vh; /* Allow content to expand */
                height: auto; /* Remove fixed height constraint */
            }
            
            .header {
                padding: 12px 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .main-container {
                flex-direction: column;
                gap: 12px;
                padding: 10px;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
                max-height: none;
                padding: 15px;
                flex-shrink: 0;
                min-height: 60vh; /* Reduced to eliminate extra bottom space */
                margin: 0 auto;
                box-sizing: border-box;
                flex: none; /* Override desktop flex:1 behavior for mobile */
                max-width: none; /* Remove desktop width constraint */
                display: flex;
                flex-direction: column;
            }
            
            #map {
                order: 1;
                flex: 1;
                min-height: 55vh; /* Increased due to reduced sidebar height */
                max-height: 60vh; /* Increased due to reduced sidebar height */
            }
            
            .summary-stats {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .stat-card {
                padding: 12px 8px;
            }
            
            .stat-number {
                font-size: 1.3rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            .staff-info {
                margin-bottom: 15px;
                padding-bottom: 12px;
            }
            
            .staff-avatar {
                width: 45px;
                height: 45px;
                margin-right: 12px;
            }
            
            .staff-details h3 {
                font-size: 0.95rem;
            }
            
            .staff-details p {
                font-size: 0.8rem;
            }
            
            .timeline {
                max-height: 250px;
            }
            
            .timeline-marker {
                width: 25px;
                height: 25px;
                font-size: 11px;
                margin-right: 12px;
            }
            
            .timeline-content h4 {
                font-size: 0.85rem;
            }
            
            .timeline-content p {
                font-size: 0.75rem;
            }
            
            .recenter-button {
                width: 45px;
                height: 45px;
                top: 10px;
                right: 10px;
            }
            
            .recenter-button::before {
                font-size: 16px;
            }
            
            .add-place-button {
                width: 65px;
                height: 65px;
                bottom: 15px;
                right: 15px;
            }
            
            .add-place-button::before {
                font-size: 30px;
            }
        }
        
        /* Small Mobile Styles (max-width: 480px) */
        @media screen and (max-width: 480px) {
            .header {
                padding: 10px 8px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .main-container {
                padding: 8px;
                gap: 8px;
            }
            
            .sidebar {
                padding: 12px;
                border-radius: 10px;
                max-height: none; /* Remove height constraint */
                min-height: 55vh; /* Reduced to eliminate extra bottom space */
                margin: 0 auto;
                box-sizing: border-box;
            }
            
            #map {
                border-radius: 10px;
                min-height: 60vh; /* Increased due to reduced sidebar height */
                max-height: 65vh; /* Increased due to reduced sidebar height */
            }
            
            .summary-stats {
                gap: 6px;
            }
            
            .stat-card {
                padding: 10px 6px;
                border-radius: 8px;
            }
            
            .stat-number {
                font-size: 1.2rem;
            }
            
            .staff-avatar {
                width: 40px;
                height: 40px;
                margin-right: 10px;
            }
            
            .staff-details h3 {
                font-size: 0.9rem;
            }
            
            .staff-details p {
                font-size: 0.75rem;
            }
            
            .timeline-marker {
                width: 22px;
                height: 22px;
                font-size: 10px;
                margin-right: 10px;
            }
            
            .timeline-content h4 {
                font-size: 0.8rem;
            }
            
            .timeline-content p {
                font-size: 0.7rem;
            }
            
            .timeline {
                max-height: 200px;
            }
            
            .recenter-button {
                width: 40px;
                height: 40px;
                top: 8px;
                right: 8px;
            }
            
            .recenter-button::before {
                font-size: 14px;
            }
            
            .add-place-button {
                width: 60px;
                height: 60px;
                bottom: 15px;
                right: 15px;
            }
            
            .add-place-button::before {
                font-size: 28px;
            }
        }
        
        /* Extra Small Mobile Styles (max-width: 320px) */
        @media screen and (max-width: 320px) {
            .header {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .main-container {
                padding: 6px;
                gap: 6px;
            }
            
            .sidebar {
                max-height: 30vh;
                min-height: 150px;
                padding: 10px;
                margin: 0 auto;
                box-sizing: border-box;
            }
            
            #map {
                min-height: 75vh;
                max-height: 80vh;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            .recenter-button {
                width: 35px;
                height: 35px;
                top: 6px;
                right: 6px;
            }
            
            .recenter-button::before {
                font-size: 12px;
            }
            
            .add-place-button {
                width: 55px;
                height: 55px;
                bottom: 12px;
                right: 12px;
            }
            
            .add-place-button::before {
                font-size: 26px;
            }
        }
        
        /* Landscape Mobile Orientation */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 6px 10px;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .header p {
                font-size: 0.75rem;
            }
            
            .main-container {
                flex-direction: row;
                padding: 8px;
                gap: 10px;
            }
            
            .sidebar {
                width: 280px;
                order: 1;
                max-height: none;
                min-height: 0;
                flex: 0 0 280px;
            }
            
            #map {
                order: 2;
                flex: 1;
                min-height: 0;
                max-height: none;
            }
        }
        
        /* Tablet Landscape Specific */
        @media screen and (min-width: 768px) and (max-height: 600px) and (orientation: landscape) {
            .sidebar {
                width: 300px;
                flex: 0 0 300px;
            }
        }
        
        /* Animation for marker pop effect and enhanced animations */
        @keyframes markerPop {
            0% { 
                transform: scale(0) rotate(45deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.3) rotate(0deg); 
                opacity: 0.8; 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }
        
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* Pulse animation for active markers */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 16px rgba(0,0,0,0.6);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>TRACE THE PATH</h1>
        <p>FOR BOOTH LEVEL OFFICERS</p>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="staff-info">
                <div class="staff-avatar" id="staffAvatar">MK</div>
                <div class="staff-details">
                    <h3 id="staffName">Loading... <span class="status-online"></span></h3>
                    <p id="staffIdRole">Loading...</p>
                    <p id="staffLocation">Loading...</p>
                </div>
            </div>
            
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-stops">0</div>
                    <div class="stat-label">Total Stops</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-photos">0</div>
                    <div class="stat-label">Photos Taken</div>
                </div>
            </div>
            
            <h4 style="color: #2c3e50; margin-bottom: 15px;">üìç Movement Timeline</h4>
            <div class="timeline" id="timeline">
                <!-- Timeline items will be populated by JavaScript -->
            </div>
        </div>
        
        <div id="map">
            <button class="recenter-button" id="recenterBtn" title="Recenter Map"></button>
            <button class="add-place-button" id="addPlaceBtn" title="Add New Place"></button>
        </div>
    </div>
    
    <script>
        // Function to load officer profile dynamically
        async function loadOfficerProfile() {
            console.log('=== LOADING OFFICER PROFILE ===');
            
            // Method 1: Check sessionStorage for tracking data (from admin)
            const trackingData = sessionStorage.getItem('trackingOfficer');
            if (trackingData) {
                try {
                    const officerData = JSON.parse(trackingData);
                    console.log('‚úÖ ADMIN TRACKING MODE - Data from sessionStorage:', officerData);
                    
                    // Fetch full officer details from Firebase using the officer ID
                    await fetchOfficerFromFirebase(officerData.officerId, 'admin');
                    return;
                } catch (error) {
                    console.error('Error parsing tracking data from sessionStorage:', error);
                }
            }
            
            // Method 2: Check URL parameters (fallback for backward compatibility)
            const urlParams = new URLSearchParams(window.location.search);
            const officerId = urlParams.get('officerId');
            const officerName = urlParams.get('officerName');
            
            if (officerId) {
                console.log('‚úÖ URL PARAMETER MODE - Fetching from Firebase:', { officerId, officerName });
                await fetchOfficerFromFirebase(officerId, 'url_fallback');
                return;
            } 
            
            // Method 3: Check current user from session (officer login)
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            if (currentUser.email) {
                console.log('‚úÖ OFFICER LOGIN MODE - Fetching own profile:', currentUser);
                
                // Try to fetch by email first, then by ID
                await fetchOfficerFromFirebase(currentUser.email, 'self', 'email');
                return;
            }
            
            console.log('‚ö†Ô∏è FALLBACK MODE - No tracking data found');
            showFallbackProfile();
        }

        // Function to fetch officer details from Firebase users collection
        async function fetchOfficerFromFirebase(identifier, mode, searchBy = 'id') {
            console.log(`üîç Fetching officer from Firebase by ${searchBy}:`, identifier);
            
            try {
                if (!window.firebaseDB) {
                    console.error('Firebase not initialized');
                    showFallbackProfile();
                    return;
                }

                const { collection, query, where, getDocs } = window.firebaseModules;
                
                let q;
                if (searchBy === 'email') {
                    q = query(collection(window.firebaseDB, 'users'), where('email', '==', identifier));
                } else {
                    q = query(collection(window.firebaseDB, 'users'), where('id', '==', identifier));
                }
                
                console.log('üîç Executing Firebase query...');
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const docData = querySnapshot.docs[0].data();
                    console.log('‚úÖ Officer found in Firebase:', docData);
                    
                    const profileData = {
                        name: docData.name || 'Unknown Officer',
                        id: docData.id || identifier,
                        email: docData.email || '',
                        role: docData.role || 'Field Officer',
                        phone: docData.phone || '',
                        district: docData.district || '',
                        block: docData.block || '',
                        constituency: docData.constituency || '',
                        gpWard: docData.gpWard || '',
                        location: buildLocationString(docData),
                        trackingMode: mode,
                        trackingTimestamp: new Date().toISOString(),
                        photoURL: docData.photoURL || '',
                        reportingTo: docData.reportingTo || '',
                        lastLogin: docData.lastLogin || null,
                        createdAt: docData.createdAt || null,
                        updatedAt: docData.updatedAt || null
                    };
                    
                    console.log('üìã Complete profile data:', profileData);
                    updateProfileUI(profileData);
                } else {
                    console.log('‚ùå Officer not found in Firebase, using fallback');
                    showFallbackProfile();
                }
            } catch (error) {
                console.error('üö® Error fetching officer from Firebase:', error);
                showFallbackProfile();
            }
        }

        // Function to build location string from officer data
        function buildLocationString(officerData) {
            const parts = [];
            
            if (officerData.gpWard) parts.push(officerData.gpWard);
            if (officerData.block) parts.push(officerData.block);
            if (officerData.constituency) parts.push(officerData.constituency);
            if (officerData.district) parts.push(officerData.district);
            
            return parts.length > 0 ? parts.join(', ') : 'Field Location';
        }

        // Function to show fallback profile when Firebase data is not available
        function showFallbackProfile() {
            const profileData = {
                name: 'Demo Officer',
                id: 'DEMO123',
                email: 'demo@gov.in',
                role: 'Field Officer',
                phone: '+91-9876543210',
                district: 'Khurda',
                block: 'Bhubaneswar',
                constituency: 'Demo Constituency',
                gpWard: 'Demo GP',
                location: 'Demo Location',
                trackingMode: 'demo'
            };
            
            console.log('üìã Using fallback profile data:', profileData);
            updateProfileUI(profileData);
        }
        
        // Function to update profile UI
        function updateProfileUI(profile) {
            console.log('=== UPDATING PROFILE UI ===');
            console.log('Profile data received:', profile);
            
            // Wait a bit to ensure DOM is ready
            setTimeout(() => {
                // Generate initials for avatar fallback
                const initials = profile.name.split(' ').map(n => n[0]).join('').toUpperCase();
                console.log('Generated initials:', initials);
                
                // Update UI elements with error checking
                const staffAvatar = document.getElementById('staffAvatar');
                const staffName = document.getElementById('staffName');
                const staffIdRole = document.getElementById('staffIdRole');
                const staffLocation = document.getElementById('staffLocation');
                
                console.log('DOM Elements found:', {
                    staffAvatar: !!staffAvatar,
                    staffName: !!staffName,
                    staffIdRole: !!staffIdRole,
                    staffLocation: !!staffLocation
                });
                
                if (staffAvatar) {
                    // Display profile image if available, otherwise show initials
                    if (profile.photoURL && profile.photoURL.trim() !== '') {
                        console.log('‚úÖ Profile image found, updating avatar with image');
                        
                        // Create an image element to test if the image loads
                        const testImg = new Image();
                        testImg.onload = function() {
                            // Image loaded successfully, apply it to avatar
                            staffAvatar.style.backgroundImage = `url(${profile.photoURL})`;
                            staffAvatar.style.backgroundSize = 'cover';
                            staffAvatar.style.backgroundPosition = 'center';
                            staffAvatar.style.backgroundRepeat = 'no-repeat';
                            staffAvatar.textContent = ''; // Clear initials text
                            staffAvatar.style.color = 'transparent'; // Hide any text
                            console.log('‚úÖ Profile image loaded and displayed successfully');
                        };
                        testImg.onerror = function() {
                            // Image failed to load, fallback to initials
                            console.log('‚ö†Ô∏è Profile image failed to load, using initials fallback');
                            staffAvatar.style.backgroundImage = 'none';
                            staffAvatar.textContent = initials;
                            staffAvatar.style.color = 'white';
                        };
                        testImg.src = profile.photoURL;
                    } else {
                        console.log('‚ö†Ô∏è No profile image found, using initials fallback');
                        staffAvatar.style.backgroundImage = 'none';
                        staffAvatar.textContent = initials;
                        staffAvatar.style.color = 'white'; // Show initials text
                        console.log('‚úÖ Updated avatar with initials:', initials);
                    }
                } else {
                    console.error('‚ùå staffAvatar element not found');
                }
                
                if (staffName) {
                    staffName.innerHTML = `${profile.name} <span class="status-online"></span>`;
                    console.log('‚úÖ Updated name to:', profile.name);
                } else {
                    console.error('‚ùå staffName element not found');
                }
                
                if (staffIdRole) {
                    // Show clean role information without reporting details
                    let roleText = `ID ${profile.id} | ${profile.role}`;
                    staffIdRole.textContent = roleText;
                    console.log('‚úÖ Updated ID/Role to:', roleText);
                } else {
                    console.error('‚ùå staffIdRole element not found');
                }
                
                if (staffLocation) {
                    // Show location without phone number
                    staffLocation.textContent = profile.location;
                    console.log('‚úÖ Updated location to:', profile.location);
                } else {
                    console.error('‚ùå staffLocation element not found');
                }
                
                // Update page title based on tracking mode
                let pageTitle = `Track ${profile.name} - TRACE THE PATH`;
                if (profile.trackingMode === 'admin') {
                    pageTitle = `Tracking ${profile.name} - TRACE THE PATH`;
                } else if (profile.trackingMode === 'self') {
                    pageTitle = `${profile.name} - TRACE THE PATH`;
                }
                document.title = pageTitle;
                console.log('‚úÖ Updated page title');
                
                // Update header subtitle based on tracking mode
                const headerSubtitle = document.querySelector('.header p');
                if (headerSubtitle) {
                    let subtitle = `FOR BOOTH LEVEL OFFICERS`;
                    if (profile.trackingMode === 'admin') {
                        subtitle = `Tracking ${profile.name.split(' ')[0]}`;
                    } else if (profile.trackingMode === 'self') {
                        subtitle = `FOR BOOTH LEVEL OFFICERS`;
                    }
                    headerSubtitle.textContent = subtitle;
                    console.log('‚úÖ Updated header subtitle');
                } else {
                    console.log('‚ö†Ô∏è Header subtitle element not found');
                }
                
                // Add tracking mode indicator
                addTrackingModeIndicator(profile.trackingMode, profile.trackingTimestamp);
                
                console.log('=== PROFILE UPDATE COMPLETED ===');
                console.log('Final profile info - Name:', profile.name, 'ID:', profile.id, 'Mode:', profile.trackingMode);
            }, 100); // Small delay to ensure DOM is ready
        }

        // Function to add tracking mode indicator (disabled for clean UI)
        function addTrackingModeIndicator(mode, timestamp) {
            // Remove existing indicator if any
            const existingIndicator = document.getElementById('trackingModeIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Tracking mode indicator disabled for production
            // The function is kept for debugging purposes but doesn't create visible elements
            console.log('Tracking mode:', mode, 'at', timestamp);
        }

        // Utility function to clear tracking data
        function clearTrackingData() {
            sessionStorage.removeItem('trackingOfficer');
            console.log('üóëÔ∏è Tracking data cleared from sessionStorage');
            
            // Show confirmation
            const indicator = document.getElementById('trackingModeIndicator');
            if (indicator) {
                indicator.style.background = '#666';
                indicator.textContent = 'üóëÔ∏è Data Cleared';
                setTimeout(() => {
                    loadOfficerProfile(); // Reload with fallback data
                }, 1000);
            }
        }

        // Utility function to show tracking info
        function showTrackingInfo() {
            const trackingData = sessionStorage.getItem('trackingOfficer');
            const currentUser = sessionStorage.getItem('currentUser');
            const urlParams = new URLSearchParams(window.location.search);
            
            const info = {
                'SessionStorage - Tracking Data': trackingData ? JSON.parse(trackingData) : 'None',
                'SessionStorage - Current User': currentUser ? JSON.parse(currentUser) : 'None',
                'URL Parameters': {
                    officerId: urlParams.get('officerId'),
                    officerName: urlParams.get('officerName'),
                    officerEmail: urlParams.get('officerEmail')
                },
                'Current URL': window.location.href,
                'Timestamp': new Date().toLocaleString()
            };
            
            console.log('üîç TRACKING DEBUG INFO:', info);
            
            // Show in a popup
            const infoText = Object.entries(info)
                .map(([key, value]) => `${key}:\n${typeof value === 'object' ? JSON.stringify(value, null, 2) : value}`)
                .join('\n\n');
            
            alert(`Debug Information:\n\n${infoText}`);
        }

        // Initialize the map when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, current URL:', window.location.href);
            console.log('URL search params:', window.location.search);
            
            // Load officer profile immediately
            loadOfficerProfile();
            
            // Create the map (we'll adjust the view after loading data)
            const map = L.map('map').setView([20.2961, 85.8245], 12);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Load the JSON data and plot markers
            fetch('./bhubaneswar_block_data.json')
                .then(response => response.json())
                .then(jsonData => {
                    const data = jsonData.data;
                    const markers = [];
                    
                    // Sort locations by date/time to create proper sequence
                    const sortedData = data.slice().sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
                    
                    // Simple function to create a marker
                    function createMarker(location, index) {
                        let longitude = location.longitude;
                        if (location.id === 1 && longitude === 20.296059) {
                            longitude = 85.824500;
                        }
                        
                        const lat = location.latitude;
                        const lng = longitude;
                        
                        // Simple marker colors based on sequence
                        let markerColor = '#3498db';
                        if (index === 0) markerColor = '#2ecc71'; // Start point
                        if (index === sortedData.length - 1) markerColor = '#e74c3c'; // End point
                        
                        // Create simple marker
                        const marker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `
                                    <div style="
                                        width: 25px; 
                                        height: 25px; 
                                        border-radius: 50%; 
                                        background: ${markerColor}; 
                                        border: 3px solid white; 
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: center; 
                                        font-weight: bold; 
                                        font-size: 12px;
                                        color: white;
                                        cursor: pointer;
                                    ">${index + 1}</div>
                                `,
                                iconSize: [25, 25],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);
                        
                        // Simple popup content
                        const dateTime = new Date(location.dateTime).toLocaleString();
                        const popupContent = `
                            <div style="max-width: 250px;">
                                <h4 style="margin: 0 0 10px 0; color: #333;">Stop #${index + 1} - ID: ${location.id}</h4>
                                <p style="margin: 5px 0;"><strong>Address:</strong><br>${location.addressDetail}</p>
                                <p style="margin: 5px 0;"><strong>Landmark:</strong> ${location.landmark}</p>
                                <p style="margin: 5px 0;"><strong>Time:</strong> ${dateTime}</p>
                                <p style="margin: 5px 0;"><strong>Updated By:</strong> ${location.updatedBy}</p>
                                <p style="margin: 5px 0;"><strong>Photos:</strong> ${location.photos.length} photo(s)</p>
                                <p style="margin: 5px 0; color: ${markerColor}; font-weight: bold;">
                                    ${index === 0 ? 'üü¢ START' : index === sortedData.length - 1 ? 'üî¥ END' : 'üîµ CHECKPOINT'}
                                </p>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        markers.push(marker);
                        return marker;
                    }
                    
                    // Simple function to create all markers at once
                    function createAllMarkers() {
                        console.log('üèóÔ∏è Creating all landmark markers...');
                        
                        // Create all markers immediately
                        sortedData.forEach((location, index) => {
                            createMarker(location, index);
                        });
                        
                        console.log(`‚úì Created ${sortedData.length} landmark markers`);
                        
                        // Fit map to show all markers
                        if (markers.length > 0) {
                            const group = new L.featureGroup(markers);
                            map.fitBounds(group.getBounds().pad(0.1), {
                                animate: true,
                                duration: 1.0
                            });
                            console.log('üìç Map fitted to show all landmarks');
                        }
                    }
                    
                    // Create all markers immediately
                    createAllMarkers();
                    
                    // Populate the timeline sidebar
                    const timeline = document.getElementById('timeline');
                    let totalPhotos = 0;
                    
                    sortedData.forEach((location, index) => {
                        totalPhotos += location.photos.length;
                        
                        const time = new Date(location.dateTime);
                        const timeString = time.toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit',
                            hour12: true 
                        });
                        
                        let markerClass = 'checkpoint';
                        let statusIcon = 'üìç';
                        let statusText = 'Meeting';
                        
                        if (index === 0) {
                            markerClass = 'start';
                            statusIcon = 'üü¢';
                            statusText = 'Sign in';
                        } else if (index === sortedData.length - 1) {
                            markerClass = 'end';
                            statusIcon = 'üî¥';
                            statusText = 'Sign out';
                        }
                        
                        const timelineItem = `
                            <div class="timeline-item">
                                <div class="timeline-marker ${markerClass}">${index + 1}</div>
                                <div class="timeline-content">
                                    <h4>${statusIcon} ${statusText} at ${timeString}</h4>
                                    <p><strong>${location.landmark}</strong></p>
                                    <p>${location.addressDetail}</p>
                                    <p style="color: #3498db;">üì∏ ${location.photos.length} photo(s) taken</p>
                                </div>
                            </div>
                        `;
                        
                        timeline.innerHTML += timelineItem;
                    });
                    
                    // Update summary stats
                    document.getElementById('total-stops').textContent = sortedData.length;
                    document.getElementById('total-photos').textContent = totalPhotos;
                    
                    // Set up recenter button functionality
                    const recenterBtn = document.getElementById('recenterBtn');
                    recenterBtn.addEventListener('click', function() {
                        // Fit to all markers
                        if (markers.length > 0) {
                            const group = new L.featureGroup(markers);
                            const bounds = group.getBounds().pad(0.1);
                            map.fitBounds(bounds, {
                                padding: [20, 20],
                                duration: 1.0,
                                easeLinearity: 0.5
                            });
                        }
                        
                        // Visual feedback
                        recenterBtn.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            recenterBtn.style.transform = 'scale(1)';
                        }, 150);
                        
                        console.log('üìç Map recentered to show all landmarks');
                    });
                    
                    // Set up add place button functionality
                    const addPlaceBtn = document.getElementById('addPlaceBtn');
                    addPlaceBtn.addEventListener('click', function() {
                        // Visual feedback
                        addPlaceBtn.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            addPlaceBtn.style.transform = 'scale(1)';
                            // Redirect to addPlace.html
                            window.location.href = './addPlace.html';
                        }, 150);
                        
                        console.log('Redirecting to Add Place page');
                    });
                    console.log(`Loaded ${data.length} field staff locations for display`);
                })
                .catch(error => {
                    console.error('Error loading location data:', error);
                    // Fallback to default location if JSON fails to load
                    const defaultMarker = L.marker([20.2961, 85.8245]).addTo(map);
                    defaultMarker.bindPopup('Default Location - Bhubaneswar').openPopup();
                });
        });
    </script>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</body>
</html> 