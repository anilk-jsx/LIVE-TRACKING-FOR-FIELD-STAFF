<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Tracking for Field Staff</title>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, getDoc, limit, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3Fm6yUsQd2O-yD3HhccHIvGUAZKiP7u0",
            authDomain: "trace-the-path.firebaseapp.com",
            projectId: "trace-the-path",
            storageBucket: "trace-the-path.firebasestorage.app",
            messagingSenderId: "818537545903",
            appId: "1:818537545903:web:50da1e17e4c3b457fed45a",
            measurementId: "G-5VP540RKTP"
        };

        // Initialize Firebase with error handling
        try {
            console.log('Initializing Firebase for tracking page...');
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // Make Firebase available globally
            window.firebaseDB = db;
            window.firebaseAuth = auth;
            window.firebaseModules = {
                collection,
                query,
                where,
                getDocs,
                doc,
                getDoc,
                limit,
                setDoc,
                updateDoc,
                serverTimestamp,
                updatePassword,
                reauthenticateWithCredential,
                EmailAuthProvider
            };
            
            console.log('Firebase initialized successfully for tracking page');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            
            // Handle OAuth domain errors gracefully
            if (error.message && error.message.includes('domain') && error.message.includes('authorized')) {
                console.warn('OAuth Domain Issue - Add', window.location.hostname, 'to Firebase authorized domains');
                console.log('Tracking will continue with URL parameter data instead of Firebase lookup');
            }
        }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            overflow: hidden; /* No scrollbars on desktop */
            height: 100vh; /* Fixed viewport height for desktop */
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            position: relative; /* For absolute positioning of logout button */
        }
        
        .header h1 {
            margin: 0;
            font-size: 3rem;
            font-weight: bold;
            color: #3498db;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .header p {
            margin: 5px 0 0 0;
            font-size: 1.2rem;
            color: #ecf0f1;
        }
        
        /* User Menu Dropdown Styles */
        .user-menu {
            position: absolute;
            top: 15px;
            right: 20px;
            z-index: 1000;
        }
        
        .user-menu-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }
        
        .user-menu-button:hover {
            background: linear-gradient(45deg, #2980b9, #2471a3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }
        
        .user-icon {
            font-size: 16px;
        }
        
        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.3s ease;
        }
        
        .user-menu.open .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid #e1e8ed;
        }
        
        .user-menu.open .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .dropdown-item:first-child {
            border-radius: 10px 10px 0 0;
        }
        
        .dropdown-item:last-child {
            border-radius: 0 0 10px 10px;
        }
        
        .dropdown-item:hover {
            background: #f8f9fa;
            color: #2980b9;
        }
        
        .logout-item:hover {
            background: #fee;
            color: #e74c3c;
        }
        
        .dropdown-divider {
            height: 1px;
            background: #e1e8ed;
            margin: 0;
        }
        
        .item-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }
        
        .item-text {
            flex: 1;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 15px 20px;
            overflow: hidden;
        }
        
        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px 20px 30px 20px; /* Added bottom padding */
            color: #333;
            overflow: hidden; /* Hide scrollbars */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            flex: 1; /* Same as map - takes available space for perfect centering */
            max-width: 350px; /* Maintain sidebar width while allowing flex behavior */
        }
        
        .staff-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .staff-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 15px;
        }
        
        .staff-details h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .staff-details p {
            margin: 2px 0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }z
        
        .status-online {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #2ecc71;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .timeline {
            flex: 1;
            overflow-y: auto; /* Scrollbar only when content overflows */
            overflow-x: hidden;
            padding-right: 5px; /* Space for scrollbar */
            min-height: 0; /* Allow flex item to shrink below content size */
        }
        
        .timeline-item {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(248, 249, 250, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .timeline-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .timeline-marker.start { background: #2ecc71; }
        .timeline-marker.checkpoint { background: #3498db; }
        .timeline-marker.end { background: #e74c3c; }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-content h4 {
            margin: 0 0 3px 0;
            color: #1a1a1a;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .timeline-content p {
            margin: 1px 0;
            color: #444444;
            font-size: 0.75rem;
            line-height: 1.3;
        }
        
        #map {
            flex: 1;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .recenter-button {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            font-size: 18px;
        }
        
        .recenter-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, #2980b9, #27ae60);
        }
        
        .recenter-button:active {
            transform: scale(0.95);
        }
        
        .recenter-button::before {
            content: '🎯';
            font-size: 20px;
        }
        
        .add-place-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            font-size: 28px;
            font-weight: bold;
        }
        
        .add-place-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, #27ae60, #229954);
        }
        
        .add-place-button:active {
            transform: scale(0.95);
        }
        
        .add-place-button::before {
            content: '+';
            font-size: 32px;
            line-height: 1;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        /* Responsive Design - Mobile First */
        
        /* Tablet Styles (768px - 1024px) */
        @media screen and (max-width: 1024px) {
            .sidebar {
                width: 300px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .main-container {
                gap: 15px;
                padding: 15px;
            }
        }
        
        /* Mobile Styles (max-width: 768px) */
        @media screen and (max-width: 768px) {
            body {
                overflow-y: auto; /* Enable vertical scrollbar on mobile */
                min-height: 100vh; /* Allow content to expand */
                height: auto; /* Remove fixed height constraint */
            }
            
            .header {
                padding: 12px 10px;
            }
            
            /* Mobile user menu adjustments */
            .user-menu {
                top: 10px;
                right: 10px;
            }
            
            .user-menu-button {
                padding: 8px 12px;
                font-size: 12px;
                border-radius: 20px;
            }
            
            .user-icon {
                font-size: 14px;
            }
            
            .dropdown-arrow {
                font-size: 8px;
            }
            
            .user-dropdown {
                min-width: 160px;
                font-size: 13px;
            }
            
            .dropdown-item {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .main-container {
                flex-direction: column;
                gap: 12px;
                padding: 10px;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
                max-height: none;
                padding: 15px;
                flex-shrink: 0;
                min-height: 60vh; /* Reduced to eliminate extra bottom space */
                margin: 0 auto;
                box-sizing: border-box;
                flex: none; /* Override desktop flex:1 behavior for mobile */
                max-width: none; /* Remove desktop width constraint */
                display: flex;
                flex-direction: column;
            }
            
            #map {
                order: 1;
                flex: 1;
                min-height: 55vh; /* Increased due to reduced sidebar height */
                max-height: 60vh; /* Increased due to reduced sidebar height */
            }
            
            .summary-stats {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .stat-card {
                padding: 12px 8px;
            }
            
            .stat-number {
                font-size: 1.3rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            .staff-info {
                margin-bottom: 15px;
                padding-bottom: 12px;
            }
            
            .staff-avatar {
                width: 45px;
                height: 45px;
                margin-right: 12px;
            }
            
            .staff-details h3 {
                font-size: 0.95rem;
            }
            
            .staff-details p {
                font-size: 0.8rem;
            }
            
            .timeline {
                max-height: 250px;
            }
            
            .timeline-marker {
                width: 25px;
                height: 25px;
                font-size: 11px;
                margin-right: 12px;
            }
            
            .timeline-content h4 {
                font-size: 0.85rem;
            }
            
            .timeline-content p {
                font-size: 0.75rem;
            }
            
            .recenter-button {
                width: 45px;
                height: 45px;
                top: 10px;
                right: 10px;
            }
            
            .recenter-button::before {
                font-size: 16px;
            }
            
            .add-place-button {
                width: 65px;
                height: 65px;
                bottom: 15px;
                right: 15px;
            }
            
            .add-place-button::before {
                font-size: 30px;
            }
        }
        
        /* Small Mobile Styles (max-width: 480px) */
        @media screen and (max-width: 480px) {
            .header {
                padding: 10px 8px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .main-container {
                padding: 8px;
                gap: 8px;
            }
            
            .sidebar {
                padding: 12px;
                border-radius: 10px;
                max-height: none; /* Remove height constraint */
                min-height: 55vh; /* Reduced to eliminate extra bottom space */
                margin: 0 auto;
                box-sizing: border-box;
            }
            
            #map {
                border-radius: 10px;
                min-height: 60vh; /* Increased due to reduced sidebar height */
                max-height: 65vh; /* Increased due to reduced sidebar height */
            }
            
            .summary-stats {
                gap: 6px;
            }
            
            .stat-card {
                padding: 10px 6px;
                border-radius: 8px;
            }
            
            .stat-number {
                font-size: 1.2rem;
            }
            
            .staff-avatar {
                width: 40px;
                height: 40px;
                margin-right: 10px;
            }
            
            .staff-details h3 {
                font-size: 0.9rem;
            }
            
            .staff-details p {
                font-size: 0.75rem;
            }
            
            .timeline-marker {
                width: 22px;
                height: 22px;
                font-size: 10px;
                margin-right: 10px;
            }
            
            .timeline-content h4 {
                font-size: 0.8rem;
            }
            
            .timeline-content p {
                font-size: 0.7rem;
            }
            
            .timeline {
                max-height: 200px;
            }
            
            .recenter-button {
                width: 40px;
                height: 40px;
                top: 8px;
                right: 8px;
            }
            
            .recenter-button::before {
                font-size: 14px;
            }
            
            .add-place-button {
                width: 60px;
                height: 60px;
                bottom: 15px;
                right: 15px;
            }
            
            .add-place-button::before {
                font-size: 28px;
            }
        }
        
        /* Extra Small Mobile Styles (max-width: 320px) */
        @media screen and (max-width: 320px) {
            .header {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .main-container {
                padding: 6px;
                gap: 6px;
            }
            
            .sidebar {
                max-height: 30vh;
                min-height: 150px;
                padding: 10px;
                margin: 0 auto;
                box-sizing: border-box;
            }
            
            #map {
                min-height: 75vh;
                max-height: 80vh;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            .recenter-button {
                width: 35px;
                height: 35px;
                top: 6px;
                right: 6px;
            }
            
            .recenter-button::before {
                font-size: 12px;
            }
            
            .add-place-button {
                width: 55px;
                height: 55px;
                bottom: 12px;
                right: 12px;
            }
            
            .add-place-button::before {
                font-size: 26px;
            }
        }
        
        /* Landscape Mobile Orientation */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 6px 10px;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .header p {
                font-size: 0.75rem;
            }
            
            .main-container {
                flex-direction: row;
                padding: 8px;
                gap: 10px;
            }
            
            .sidebar {
                width: 280px;
                order: 1;
                max-height: none;
                min-height: 0;
                flex: 0 0 280px;
            }
            
            #map {
                order: 2;
                flex: 1;
                min-height: 0;
                max-height: none;
            }
        }
        
        /* Tablet Landscape Specific */
        @media screen and (min-width: 768px) and (max-height: 600px) and (orientation: landscape) {
            .sidebar {
                width: 300px;
                flex: 0 0 300px;
            }
        }
        
        /* Animation for marker pop effect and enhanced animations */
        @keyframes markerPop {
            0% { 
                transform: scale(0) rotate(45deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.3) rotate(0deg); 
                opacity: 0.8; 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }
        
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* Pulse animation for active markers */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 16px rgba(0,0,0,0.6);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>TRACE THE PATH</h1>
        <p>FOR BOOTH LEVEL OFFICERS</p>
        
        <!-- User Menu Dropdown - Top Right -->
        <div class="user-menu" id="userMenu">
            <button class="user-menu-button" onclick="toggleUserMenu()" title="User Menu">
                <span class="user-icon">👤</span>
                <span class="dropdown-arrow">▼</span>
            </button>
            
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-item" onclick="changePassword()">
                    <span class="item-icon">🔑</span>
                    <span class="item-text">Change Password</span>
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item logout-item" onclick="logoutUser()">
                    <span class="item-icon">🚪</span>
                    <span class="item-text">Logout</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="staff-info">
                <div class="staff-avatar" id="staffAvatar">MK</div>
                <div class="staff-details">
                    <h3 id="staffName">Loading... <span class="status-online"></span></h3>
                    <p id="staffIdRole">Loading...</p>
                    <p id="staffLocation">Loading...</p>
                    <div id="dateSelectorContainer" style="margin-top:10px;">
                        <select id="dateSelector" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e1e8ed;font-size:0.95rem;color:#333;"></select>
                    </div>
                </div>
            </div>
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-stops">0</div>
                    <div class="stat-label">Total Stops</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-photos">0</div>
                    <div class="stat-label">Photos Taken</div>
                </div>
            </div>
            

            <h4 style="color: #2c3e50; margin-bottom: 15px;">📍 Movement Timeline</h4>
            <div class="timeline" id="timeline">
                <!-- Timeline items will be populated by JavaScript -->
            </div>
        </div>
        
        <div id="map">
            <button class="recenter-button" id="recenterBtn" title="Recenter Map"></button>
            <button class="add-place-button" id="addPlaceBtn" title="Add New Place"></button>
        </div>
    </div>
    
    <script>
        // Function to load officer profile dynamically
        async function loadOfficerProfile() {
            console.log('=== LOADING OFFICER PROFILE ===');
            
            // Show loading state immediately
            showLoadingState();
            
            // Method 1: Check sessionStorage for tracking data (from admin)
            const trackingData = sessionStorage.getItem('trackingOfficer');
            if (trackingData) {
                try {
                    const officerData = JSON.parse(trackingData);
                    console.log('✅ ADMIN TRACKING MODE - Data from sessionStorage:', officerData);
                    
                    // Fetch full officer details from Firebase using the officer ID
                    await fetchOfficerFromFirebase(officerData.officerId, 'admin');
                    return;
                } catch (error) {
                    console.error('Error parsing tracking data from sessionStorage:', error);
                }
            }
            
            // Method 2: Check URL parameters (fallback for backward compatibility)
            const urlParams = new URLSearchParams(window.location.search);
            const officerId = urlParams.get('officerId');
            const officerName = urlParams.get('officerName');
            
            if (officerId) {
                console.log('✅ URL PARAMETER MODE - Fetching from Firebase:', { officerId, officerName });
                await fetchOfficerFromFirebase(officerId, 'url_fallback');
                return;
            } 
            
            // Method 3: Check current user from session (officer login)
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            if (currentUser && (currentUser.uid || currentUser.email)) {
                console.log('✅ OFFICER LOGIN MODE - Fetching own profile:', currentUser);

                // Prefer lookup by UID (document id) when available, otherwise fall back to email
                const searchBy = currentUser.uid ? 'uid' : 'email';
                const identifier = currentUser.uid ? currentUser.uid : currentUser.email;

                // Try to fetch profile from Firestore (best-effort). The fetch function will
                // call ensureDailySubmissionDocument(profileData.id) only when the user's
                // numeric `id` (from the users collection) is found. This ensures the per-day
                // document is named using the users collection `id` field: `<id>_YYYY-MM-DD`.
                try {
                    await fetchOfficerFromFirebase(identifier, 'self', searchBy);
                } catch (e) {
                    console.warn('Error fetching profile for current user:', e);
                    // If profile can't be fetched, do not create a per-day document using UID/email here,
                    // because the requirement is to use the numeric `id` from the users collection.
                }

                return;
            }
            
            console.log('⚠️ FALLBACK MODE - No tracking data found');
            showFallbackProfile();
        }

        // Function to show loading state
        function showLoadingState() {
            const staffName = document.getElementById('staffName');
            const staffIdRole = document.getElementById('staffIdRole');
            const staffLocation = document.getElementById('staffLocation');
            
            if (staffName) staffName.innerHTML = 'Loading... <span class="status-online"></span>';
            if (staffIdRole) staffIdRole.textContent = 'Loading profile...';
            if (staffLocation) staffLocation.textContent = 'Fetching location...';
        }

        // Function to fetch officer details from Firebase users collection
        async function fetchOfficerFromFirebase(identifier, mode, searchBy = 'id') {
            console.log(`🔍 Fetching officer from Firebase by ${searchBy}:`, identifier);
            
            try {
                if (!window.firebaseDB) {
                    console.error('Firebase not initialized');
                    showFallbackProfile();
                    return;
                }

                const { collection, query, where, getDocs, limit, doc: docFn, getDoc } = window.firebaseModules;

                let docData = null;

                // If caller requested a UID/document lookup, try direct document read first
                if (searchBy === 'uid' || searchBy === 'id') {
                    try {
                        console.log('🔍 Attempting direct user document lookup by id:', identifier);
                        const userDocRef = docFn(window.firebaseDB, 'users', identifier);
                        const userSnap = await getDoc(userDocRef);
                        if (userSnap.exists()) {
                            docData = userSnap.data();
                            console.log('✅ Officer found via document lookup:', docData);
                        } else {
                            console.log('🔎 No user document found at users/', identifier);
                        }
                    } catch (err) {
                        console.warn('Direct document lookup failed:', err);
                    }
                }

                // If not found by document id, fall back to indexed queries (email or id field)
                if (!docData) {
                    try {
                        let q;
                        if (searchBy === 'email') {
                            q = query(collection(window.firebaseDB, 'users'), where('email', '==', identifier), limit(1));
                        } else {
                            q = query(collection(window.firebaseDB, 'users'), where('id', '==', identifier), limit(1));
                        }

                        console.log('🔍 Executing optimized Firebase query...');
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            docData = querySnapshot.docs[0].data();
                            console.log('✅ Officer found in Firebase via query:', docData);
                        }
                    } catch (err) {
                        console.warn('Query lookup failed:', err);
                    }
                }

                if (docData) {
                    const profileData = {
                        name: docData.name || 'Unknown Officer',
                        id: docData.id || identifier,
                        email: docData.email || '',
                        role: docData.role || 'Field Officer',
                        phone: docData.phone || '',
                        district: docData.district || '',
                        block: docData.block || '',
                        constituency: docData.constituency || '',
                        gpWard: docData.gpWard || '',
                        location: buildLocationString(docData),
                        trackingMode: mode,
                        trackingTimestamp: new Date().toISOString(),
                        photoURL: docData.photoURL || '',
                        reportingTo: docData.reportingTo || '',
                        lastLogin: docData.lastLogin || null,
                        createdAt: docData.createdAt || null,
                        updatedAt: docData.updatedAt || null
                    };

                    console.log('📋 Complete profile data:', profileData);
                    updateProfileUI(profileData);

                    // If this is an officer's own session (not admin viewing), ensure daily doc
                    try {
                        if (mode === 'self' || profileData.trackingMode === 'self' || profileData.trackingMode === 'demo') {
                            await ensureDailySubmissionDocument(profileData.id);

                            // After ensuring today's doc exists, load available dates and default view
                            try {
                                await loadAvailableDates(profileData.id);
                                const selector = document.getElementById('dateSelector');
                                if (selector && selector.value) {
                                    // Load the selected date (defaults to today)
                                    await loadSubmissionByDate(profileData.id, selector.value);
                                }
                            } catch (innerErr) {
                                console.warn('Failed to load available dates or submission doc:', innerErr);
                            }
                        } else if (mode === 'admin' || profileData.trackingMode === 'admin') {
                            // Admin viewing: populate date selector and honor any selectedDate passed via sessionStorage
                            try {
                                await loadAvailableDates(profileData.id);
                                const selector = document.getElementById('dateSelector');

                                // Check for admin-selected date in sessionStorage
                                let adminSelectedDate = null;
                                try {
                                    const tr = sessionStorage.getItem('trackingOfficer');
                                    if (tr) {
                                        const tro = JSON.parse(tr);
                                        adminSelectedDate = tro.selectedDate || tro.selected_date || null;
                                    }
                                } catch (ee) {
                                    console.warn('Error reading trackingOfficer from sessionStorage:', ee);
                                }

                                if (selector) {
                                    if (adminSelectedDate) {
                                        // If the date isn't already present in options, append it
                                        let found = false;
                                        for (let i = 0; i < selector.options.length; i++) {
                                            if (selector.options[i].value === adminSelectedDate) { found = true; break; }
                                        }
                                        if (!found) {
                                            const opt = document.createElement('option');
                                            opt.value = adminSelectedDate;
                                            opt.textContent = adminSelectedDate;
                                            selector.appendChild(opt);
                                        }
                                        selector.value = adminSelectedDate;
                                    } else if (selector.options.length > 0) {
                                        selector.value = selector.options[0].value;
                                    }

                                    // Load the selected date (adminSelectedDate or default)
                                    if (selector && selector.value) await loadSubmissionByDate(profileData.id, selector.value);
                                }
                            } catch (innerErr) {
                                console.warn('Failed to load available dates for admin view:', innerErr);
                            }
                        }
                    } catch (e) {
                        console.warn('Could not ensure daily document after profile fetch:', e);
                    }
                } else {
                    console.log('❌ Officer not found in Firebase, using fallback');
                    showFallbackProfile();
                }
            } catch (error) {
                console.error('🚨 Error fetching officer from Firebase:', error);
                showFallbackProfile();
            }
        }

        // Function to build location string from officer data
        function buildLocationString(officerData) {
            const parts = [];
            
            if (officerData.gpWard) parts.push(officerData.gpWard);
            if (officerData.block) parts.push(officerData.block);
            if (officerData.constituency) parts.push(officerData.constituency);
            if (officerData.district) parts.push(officerData.district);
            
            return parts.length > 0 ? parts.join(', ') : 'Field Location';
        }

        // Function to show fallback profile when Firebase data is not available
        function showFallbackProfile() {
            const profileData = {
                name: 'Demo Officer',
                id: 'DEMO123',
                email: 'demo@gov.in',
                role: 'Field Officer',
                phone: '+91-9876543210',
                district: 'Khurda',
                block: 'Bhubaneswar',
                constituency: 'Demo Constituency',
                gpWard: 'Demo GP',
                location: 'Demo Location',
                trackingMode: 'demo'
            };
            
            console.log('📋 Using fallback profile data:', profileData);
            updateProfileUI(profileData);
        }
        
        // Function to update profile UI
        function updateProfileUI(profile) {
            console.log('=== UPDATING PROFILE UI ===');
            console.log('Profile data received:', profile);
            
            // Generate initials for avatar fallback
            const initials = profile.name.split(' ').map(n => n[0]).join('').toUpperCase();
            console.log('Generated initials:', initials);
            
            // Update UI elements with error checking
            const staffAvatar = document.getElementById('staffAvatar');
            const staffName = document.getElementById('staffName');
            const staffIdRole = document.getElementById('staffIdRole');
            const staffLocation = document.getElementById('staffLocation');
            
            console.log('DOM Elements found:', {
                staffAvatar: !!staffAvatar,
                staffName: !!staffName,
                staffIdRole: !!staffIdRole,
                staffLocation: !!staffLocation
            });
            
            if (staffAvatar) {
                // Display profile image if available, otherwise show initials
                if (profile.photoURL && profile.photoURL.trim() !== '') {
                    console.log('✅ Profile image found, updating avatar with image');
                    
                    // Create an image element to test if the image loads
                    const testImg = new Image();
                    testImg.onload = function() {
                        // Image loaded successfully, apply it to avatar
                        staffAvatar.style.backgroundImage = `url(${profile.photoURL})`;
                        staffAvatar.style.backgroundSize = 'cover';
                        staffAvatar.style.backgroundPosition = 'center';
                        staffAvatar.style.backgroundRepeat = 'no-repeat';
                        staffAvatar.textContent = ''; // Clear initials text
                        staffAvatar.style.color = 'transparent'; // Hide any text
                        console.log('✅ Profile image loaded and displayed successfully');
                    };
                    testImg.onerror = function() {
                        // Image failed to load, fallback to initials
                        console.log('⚠️ Profile image failed to load, using initials fallback');
                        staffAvatar.style.backgroundImage = 'none';
                        staffAvatar.textContent = initials;
                        staffAvatar.style.color = 'white';
                    };
                    testImg.src = profile.photoURL;
                } else {
                    console.log('⚠️ No profile image found, using initials fallback');
                    staffAvatar.style.backgroundImage = 'none';
                    staffAvatar.textContent = initials;
                    staffAvatar.style.color = 'white'; // Show initials text
                    console.log('✅ Updated avatar with initials:', initials);
                }
            } else {
                console.error('❌ staffAvatar element not found');
            }
            
            if (staffName) {
                staffName.innerHTML = `${profile.name} <span class="status-online"></span>`;
                console.log('✅ Updated name to:', profile.name);
            } else {
                console.error('❌ staffName element not found');
            }
            
            if (staffIdRole) {
                // Show clean role information without reporting details
                let roleText = `ID ${profile.id} | ${profile.role}`;
                staffIdRole.textContent = roleText;
                console.log('✅ Updated ID/Role to:', roleText);
            } else {
                console.error('❌ staffIdRole element not found');
            }
            
            if (staffLocation) {
                // Show location without phone number
                staffLocation.textContent = profile.location;
                console.log('✅ Updated location to:', profile.location);
            } else {
                console.error('❌ staffLocation element not found');
            }
            
            // Update page title based on tracking mode
            let pageTitle = `Track ${profile.name} - TRACE THE PATH`;
            if (profile.trackingMode === 'admin') {
                pageTitle = `Tracking ${profile.name} - TRACE THE PATH`;
            } else if (profile.trackingMode === 'self') {
                pageTitle = `${profile.name} - TRACE THE PATH`;
            }
            document.title = pageTitle;
            console.log('✅ Updated page title');
            
            // Update header subtitle based on tracking mode
            const headerSubtitle = document.querySelector('.header p');
            if (headerSubtitle) {
                let subtitle = `FOR BOOTH LEVEL OFFICERS`;
                if (profile.trackingMode === 'admin') {
                    subtitle = `Tracking ${profile.name.split(' ')[0]}`;
                } else if (profile.trackingMode === 'self') {
                    subtitle = `FOR BOOTH LEVEL OFFICERS`;
                }
                headerSubtitle.textContent = subtitle;
                console.log('✅ Updated header subtitle');
            } else {
                console.log('⚠️ Header subtitle element not found');
            }
            
            // Add tracking mode indicator
            addTrackingModeIndicator(profile.trackingMode, profile.trackingTimestamp);
            
            // Show/hide logout button based on tracking mode
            updateLogoutButtonVisibility(profile.trackingMode);
            
            console.log('=== PROFILE UPDATE COMPLETED ===');
            console.log('Final profile info - Name:', profile.name, 'ID:', profile.id, 'Mode:', profile.trackingMode);
        }

        // Ensure a date-wise submission document exists for the user for today.
        async function ensureDailySubmissionDocument(userId) {
            try {
                if (!window.firebaseDB) {
                    console.warn('Firebase DB not initialized, skipping daily document creation');
                    return;
                }

                const { doc, getDoc, setDoc, serverTimestamp } = window.firebaseModules;

                const submissionDate = new Date().toISOString().split('T')[0];
                const documentId = `${userId}_${submissionDate}`;

                console.log('Ensuring daily submission document exists for:', documentId);

                const docRef = doc(window.firebaseDB, 'userSubmissions', documentId);
                const snap = await getDoc(docRef);

                if (snap.exists()) {
                    console.log('Daily document already exists:', documentId);
                } else {
                    const nowIso = new Date().toISOString();
                    const newDocument = {
                        documentId: documentId,
                        userId: userId,
                        submissionDate: submissionDate,
                        documentCreated: serverTimestamp(),
                        lastUpdated: serverTimestamp(),
                        stats: {
                            totalPlaces: 0,
                            totalPhotos: 0,
                            firstSubmissionTime: null,
                            lastSubmissionTime: null
                        },
                        places: []
                    };

                    await setDoc(docRef, newDocument);
                    console.log('Created new daily submission document:', documentId);
                }

                // Save to session so addPlace.html can reuse it
                try {
                    sessionStorage.setItem('currentSubmissionDocId', documentId);
                    sessionStorage.setItem('currentUserId', userId);
                } catch (e) {
                    console.warn('Unable to write submission doc id to sessionStorage:', e);
                }
            } catch (error) {
                console.error('Error ensuring daily submission document:', error);
            }
        }

        // Function to update user menu visibility based on tracking mode
        function updateLogoutButtonVisibility(trackingMode) {
            const userMenu = document.querySelector('.user-menu');
            
            if (userMenu) {
                if (trackingMode === 'admin' || trackingMode === 'url_fallback') {
                    // Hide user menu when admin is viewing officer profile
                    userMenu.style.display = 'none';
                    console.log('🔒 User menu hidden - Admin viewing mode');
                } else {
                    // Show user menu for officer's own profile
                    userMenu.style.display = 'block';
                    console.log('� User menu visible - Officer own profile');
                }
            }
        }

        // Function to add tracking mode indicator (disabled for clean UI)
        function addTrackingModeIndicator(mode, timestamp) {
            // Remove existing indicator if any
            const existingIndicator = document.getElementById('trackingModeIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Tracking mode indicator disabled for production
            // The function is kept for debugging purposes but doesn't create visible elements
            console.log('Tracking mode:', mode, 'at', timestamp);
        }

        // Utility function to clear tracking data
        function clearTrackingData() {
            sessionStorage.removeItem('trackingOfficer');
            console.log('🗑️ Tracking data cleared from sessionStorage');
            
            // Show confirmation
            const indicator = document.getElementById('trackingModeIndicator');
            if (indicator) {
                indicator.style.background = '#666';
                indicator.textContent = '🗑️ Data Cleared';
                setTimeout(() => {
                    loadOfficerProfile(); // Reload with fallback data
                }, 1000);
            }
        }

        // Utility function to show tracking info
        function showTrackingInfo() {
            const trackingData = sessionStorage.getItem('trackingOfficer');
            const currentUser = sessionStorage.getItem('currentUser');
            const urlParams = new URLSearchParams(window.location.search);
            
            const info = {
                'SessionStorage - Tracking Data': trackingData ? JSON.parse(trackingData) : 'None',
                'SessionStorage - Current User': currentUser ? JSON.parse(currentUser) : 'None',
                'URL Parameters': {
                    officerId: urlParams.get('officerId'),
                    officerName: urlParams.get('officerName'),
                    officerEmail: urlParams.get('officerEmail')
                },
                'Current URL': window.location.href,
                'Timestamp': new Date().toLocaleString()
            };
            
            console.log('🔍 TRACKING DEBUG INFO:', info);
            
            // Show in a popup
            const infoText = Object.entries(info)
                .map(([key, value]) => `${key}:\n${typeof value === 'object' ? JSON.stringify(value, null, 2) : value}`)
                .join('\n\n');
            
            alert(`Debug Information:\n\n${infoText}`);
        }

        // User menu dropdown functions
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            userMenu.classList.toggle('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            const userMenuButton = userMenu?.querySelector('.user-menu-button');
            
            if (userMenu && !userMenu.contains(event.target)) {
                userMenu.classList.remove('open');
            }
        });

        // Change password function with Firebase Auth
        async function changePassword() {
            // Close the dropdown
            document.getElementById('userMenu').classList.remove('open');
            
            console.log('🔑 Change password requested');
            
            try {
                // Check if Firebase Auth is available
                if (!window.firebaseAuth) {
                    throw new Error('Firebase Auth not initialized');
                }
                
                const auth = window.firebaseAuth;
                const user = auth.currentUser;
                
                if (!user) {
                    alert('You must be logged in to change your password. Please login again.');
                    return;
                }
                
                console.log('✅ User authenticated:', user.email);
                
                // Show password change dialog with better styling
                const modalHTML = `
                    <div id="passwordModal" style="
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.5); z-index: 10000;
                        display: flex; align-items: center; justify-content: center;
                    ">
                        <div style="
                            background: white; padding: 30px; border-radius: 15px;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;
                            color: #333;
                        ">
                            <h3 style="margin: 0 0 20px 0; color: #2c3e50; text-align: center;">🔑 Change Password</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Current Password:</label>
                                <input type="password" id="currentPassword" style="
                                    width: 100%; padding: 10px; border: 2px solid #e1e8ed;
                                    border-radius: 8px; font-size: 14px; box-sizing: border-box;
                                " placeholder="Enter current password">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">New Password:</label>
                                <input type="password" id="newPassword" style="
                                    width: 100%; padding: 10px; border: 2px solid #e1e8ed;
                                    border-radius: 8px; font-size: 14px; box-sizing: border-box;
                                " placeholder="Enter new password (min 6 characters)">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Confirm New Password:</label>
                                <input type="password" id="confirmPassword" style="
                                    width: 100%; padding: 10px; border: 2px solid #e1e8ed;
                                    border-radius: 8px; font-size: 14px; box-sizing: border-box;
                                " placeholder="Confirm new password">
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: end;">
                                <button onclick="closePasswordModal()" style="
                                    padding: 10px 20px; border: 2px solid #95a5a6; background: white;
                                    color: #7f8c8d; border-radius: 8px; cursor: pointer; font-weight: 500;
                                ">Cancel</button>
                                <button onclick="submitPasswordChange()" style="
                                    padding: 10px 20px; border: none; background: linear-gradient(45deg, #3498db, #2980b9);
                                    color: white; border-radius: 8px; cursor: pointer; font-weight: 500;
                                ">Update Password</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.getElementById('currentPassword').focus();
                
            } catch (error) {
                console.error('🚨 Error initiating password change:', error);
                alert('Unable to change password. Please try again or contact support.');
            }
        }

        // Close password modal
        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (modal) {
                modal.remove();
            }
        }

        // Submit password change
        async function submitPasswordChange() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Validation
                if (!currentPassword) {
                    alert('Please enter your current password.');
                    return;
                }
                
                if (!newPassword) {
                    alert('Please enter a new password.');
                    return;
                }
                
                if (newPassword.length < 6) {
                    alert('New password must be at least 6 characters long.');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match. Please try again.');
                    return;
                }
                
                const auth = window.firebaseAuth;
                const user = auth.currentUser;
                const { updatePassword, reauthenticateWithCredential, EmailAuthProvider } = window.firebaseModules;
                
                // Show loading state
                const submitButton = document.querySelector('button[onclick="submitPasswordChange()"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Updating...';
                submitButton.disabled = true;
                
                // Re-authenticate user with current password
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                console.log('✅ User re-authenticated successfully');
                
                // Update password
                await updatePassword(user, newPassword);
                console.log('✅ Password updated successfully');
                
                // Close modal and show success
                closePasswordModal();
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.style.cssText = `
                    position: fixed; top: 50%; left: 50%; 
                    transform: translate(-50%, -50%);
                    background: #2ecc71; color: white; 
                    padding: 20px 30px; border-radius: 10px;
                    font-size: 16px; font-weight: 500;
                    z-index: 10000; text-align: center;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                `;
                successMessage.innerHTML = '✅ Password updated successfully!';
                document.body.appendChild(successMessage);
                
                setTimeout(() => {
                    successMessage.remove();
                }, 3000);
                
            } catch (error) {
                console.error('🚨 Password change error:', error);
                
                let errorMessage = 'Failed to update password. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage += 'Current password is incorrect.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += 'New password is too weak.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage += 'Please logout and login again before changing password.';
                } else {
                    errorMessage += 'Please try again.';
                }
                
                alert(errorMessage);
                
                // Reset button
                const submitButton = document.querySelector('button[onclick="submitPasswordChange()"]');
                if (submitButton) {
                    submitButton.textContent = 'Update Password';
                    submitButton.disabled = false;
                }
            }
        }

        // Logout function
        function logoutUser() {
            // Show confirmation dialog
            if (confirm('Are you sure you want to logout?')) {
                console.log('🚪 User logging out...');
                
                // Clear all session data
                sessionStorage.clear();
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userRole');
                
                // Clear tracking data
                sessionStorage.removeItem('trackingOfficer');
                sessionStorage.removeItem('currentUser');
                
                console.log('✅ Session data cleared');
                
                // Redirect to login page immediately
                window.location.href = 'index.html';
            }
        }

        // Initialize the map when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, current URL:', window.location.href);
            console.log('URL search params:', window.location.search);
            
            // Load officer profile immediately
            loadOfficerProfile();
            
            // Create the map (we'll adjust the view after loading data)
            window.map = L.map('map').setView([20.2961, 85.8245], 12);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Wire up Add Place button (redirects to addPlace.html)
            const addPlaceBtn = document.getElementById('addPlaceBtn');
            if (addPlaceBtn) {
                addPlaceBtn.addEventListener('click', function () {
                    // Navigate to addPlace.html in the same tab (user requested same-tab behavior)
                    try {
                        addPlaceBtn.style.transform = 'scale(0.95)';
                        setTimeout(() => addPlaceBtn.style.transform = 'scale(1)', 120);
                    } catch (e) {}
                    window.location.href = './addPlace.html';
                });
            }

            // After map creation, try to load submission data for the current user/date or fallback to JSON
                // We'll populate the map with data returned by Firestore documents when available.
                // NOTE: Do not auto-load demo/fallback JSON on page load. Start with an empty map and
                // only load data when a user/date is explicitly selected (or when Firestore returns a doc).
                loadInitialSubmissionView();
        });

    // Keep references to markers so we can clear them when switching dates
    let __markers = [];
    // Keep reference to the currently drawn route polyline so it can be cleared
    let __routePolyline = null;

        // Load initial view: prefer Firestore document for current user/date.
        // Important: do NOT auto-load the demo/fallback JSON here. Start with an empty map.
        async function loadInitialSubmissionView() {
            try {
                const userId = sessionStorage.getItem('currentUserId');

                if (userId) {
                    // Populate available dates but do not force rendering demo data.
                    await loadAvailableDates(userId);

                    const selector = document.getElementById('dateSelector');
                    if (selector && selector.value) {
                        await loadSubmissionByDate(userId, selector.value);
                    } else {
                        // No date selected yet — ensure map is empty and UI is reset
                        clearMapMarkers();
                        document.getElementById('timeline').innerHTML = '';
                        document.getElementById('total-stops').textContent = '0';
                        document.getElementById('total-photos').textContent = '0';
                        // Center map to default view without loading any demo markers
                        try { window.map.setView([20.2961, 85.8245], 12); } catch (e) {}
                    }
                } else {
                    // No logged user — start with empty map (no demo data)
                    clearMapMarkers();
                    document.getElementById('timeline').innerHTML = '';
                    document.getElementById('total-stops').textContent = '0';
                    document.getElementById('total-photos').textContent = '0';
                    try { window.map.setView([20.2961, 85.8245], 12); } catch (e) {}
                }
            } catch (error) {
                console.warn('Initial submission view setup failed:', error);
                // Keep the map empty on failure
                clearMapMarkers();
            }
        }

        // Keep current document data in memory so we can append new places without reloading
        window.__currentDocData = null;

        // Listen for messages from addPlace popup
        window.addEventListener('message', async function (event) {
            try {
                const data = event.data || {};
                if (!data || data.type !== 'newPlace') return;

                const place = data.place;
                if (!place || !place.location) return;

                console.log('Received new place from popup:', place);

                // Ensure we have a current doc data object
                if (!window.__currentDocData) {
                    window.__currentDocData = { places: [] };
                }

                const places = window.__currentDocData.places;
                const prev = places.length > 0 ? places[places.length - 1] : null;
                const prevCoord = prev ? [prev.location.latitude, prev.location.longitude] : null;

                // Add to memory model
                places.push(place);

                // Add marker for the new place
                const newIndex = places.length - 1;
                const marker = createMarkerFromPlace(place, newIndex, places.length);
                __markers.push(marker);

                // Update timeline UI (append)
                const timeline = document.getElementById('timeline');
                const time = new Date(place.submissionTime.iso || place.submissionTime);
                const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const markerClass = newIndex === 0 ? 'start' : newIndex === places.length - 1 ? 'end' : 'checkpoint';
                const statusIcon = newIndex === 0 ? '🟢' : newIndex === places.length - 1 ? '🔴' : '🔵';
                const statusText = newIndex === 0 ? 'Sign in' : newIndex === places.length - 1 ? 'Sign out' : 'Meeting';
                const timelineItem = `
                    <div class="timeline-item">
                        <div class="timeline-marker ${markerClass}">${newIndex + 1}</div>
                        <div class="timeline-content">
                            <h4>${statusIcon} ${statusText} at ${timeString}</h4>
                            <p><strong>${place.location.landmark}</strong></p>
                            <p>${place.location.addressDetail}</p>
                            <p style="color: #3498db;">📸 ${place.photoCount || 0} photo(s) taken</p>
                        </div>
                    </div>
                `;
                timeline.innerHTML += timelineItem;

                // Update stats
                const totalStopsEl = document.getElementById('total-stops');
                const totalPhotosEl = document.getElementById('total-photos');
                totalStopsEl.textContent = places.length;
                const currentPhotos = parseInt(totalPhotosEl.textContent || '0', 10) + (place.photoCount || 0);
                totalPhotosEl.textContent = currentPhotos;

                // Animate route extension from previous to new place
                if (prevCoord) {
                    try {
                        const seg = await buildRouteAlongRoads([prevCoord, [place.location.latitude, place.location.longitude]]);

                        // combine with existing polyline coords
                        let existing = [];
                        if (__routePolyline) existing = __routePolyline.getLatLngs().map(ll => [ll.lat, ll.lng]);

                        // avoid duplicate point at junction
                        let toConcat = seg;
                        if (existing.length && seg.length && existing[existing.length - 1] && seg[0] && existing[existing.length - 1][0] === seg[0][0] && existing[existing.length - 1][1] === seg[0][1]) {
                            toConcat = seg.slice(1);
                        }

                        const newCoords = existing.concat(toConcat);
                        if (__routePolyline) try { window.map.removeLayer(__routePolyline); } catch (e) {}
                        __routePolyline = L.polyline(newCoords, { color: '#3388ff', weight: 4, opacity: 0.85 }).addTo(window.map);

                        // Animate marker along toConcat
                        animateMarkerAlongCoordinates(prevCoord, toConcat);
                    } catch (e) {
                        console.warn('Route extension failed, adding straight segment:', e);
                        // fallback straight add
                        if (__routePolyline) {
                            __routePolyline.addLatLng([place.location.latitude, place.location.longitude]);
                        } else {
                            __routePolyline = L.polyline([[prevCoord[0], prevCoord[1]], [place.location.latitude, place.location.longitude]], { color: '#3388ff', weight: 4, opacity: 0.85 }).addTo(window.map);
                        }
                        animateMarkerAlongCoordinates(prevCoord, [[place.location.latitude, place.location.longitude]]);
                    }
                } else {
                    // No previous point, just fit to marker
                    if (__routePolyline) {
                        const groupItems = __markers.slice();
                        groupItems.push(__routePolyline);
                        const group = new L.featureGroup(groupItems);
                        window.map.fitBounds(group.getBounds().pad(0.1));
                    } else {
                        window.map.setView([place.location.latitude, place.location.longitude], 16);
                    }
                }

            } catch (err) {
                console.error('Error handling new place message:', err);
            }
        });

        // Animate a temporary marker along a series of coords (array of [lat,lng]) starting from startCoord
        function animateMarkerAlongCoordinates(startCoord, coords) {
            if (!coords || coords.length === 0) return;
            const movingMarker = L.marker([startCoord[0], startCoord[1]], { opacity: 0.9 }).addTo(window.map);
            let i = 0;
            const step = 100; // ms per step
            const interval = setInterval(() => {
                if (i >= coords.length) {
                    clearInterval(interval);
                    movingMarker.remove();
                    // focus map to include new marker/polyline
                    const groupItems = __markers.slice();
                    if (__routePolyline) groupItems.push(__routePolyline);
                    const group = new L.featureGroup(groupItems);
                    window.map.fitBounds(group.getBounds().pad(0.1));
                    return;
                }
                const p = coords[i];
                movingMarker.setLatLng([p[0], p[1]]);
                i++;
            }, step);
        }

        // Query Firestore for available submission dates for the user and populate the date selector
        async function loadAvailableDates(userId) {
            try {
                if (!window.firebaseDB) return;
                const { collection, query, where, getDocs } = window.firebaseModules;
                const q = query(collection(window.firebaseDB, 'userSubmissions'), where('userId', '==', userId));
                const snaps = await getDocs(q);
                const dates = [];
                snaps.forEach(s => {
                    const d = s.data();
                    if (d && d.submissionDate) dates.push(d.submissionDate);
                });

                // Always include today's date as option
                const today = new Date().toISOString().split('T')[0];
                if (!dates.includes(today)) dates.push(today);

                // Sort descending
                dates.sort((a, b) => b.localeCompare(a));

                const selector = document.getElementById('dateSelector');
                if (!selector) return;
                selector.innerHTML = '';
                dates.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    selector.appendChild(opt);
                });

                // When user changes date, load that document
                selector.onchange = async function() {
                    const sel = selector.value;
                    await loadSubmissionByDate(userId, sel);
                };

                // Default to first option
                if (selector.options.length > 0) selector.value = selector.options[0].value;
            } catch (error) {
                console.warn('Failed to load available dates:', error);
            }
        }

        // Load and render submission document for given userId and date (YYYY-MM-DD)
        async function loadSubmissionByDate(userId, date) {
            try {
                if (!window.firebaseDB) {
                    console.warn('Firebase not initialized');
                    // Keep map empty instead of falling back to demo data
                    clearMapMarkers();
                    document.getElementById('timeline').innerHTML = '';
                    document.getElementById('total-stops').textContent = '0';
                    document.getElementById('total-photos').textContent = '0';
                    return;
                }
                const { doc, getDoc } = window.firebaseModules;
                const documentId = `${userId}_${date}`;
                const docRef = doc(window.firebaseDB, 'userSubmissions', documentId);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const data = snap.data();
                    sessionStorage.setItem('currentSubmissionDocId', documentId);
                    sessionStorage.setItem('currentUserId', userId);
                    await renderSubmissionData(data);
                } else {
                    console.log('No submission document for', documentId, '— not loading demo data; showing empty map');
                    // Clear current session doc id but keep userId
                    sessionStorage.removeItem('currentSubmissionDocId');
                    // Clear UI/map instead of loading fallback JSON
                    clearMapMarkers();
                    document.getElementById('timeline').innerHTML = '';
                    document.getElementById('total-stops').textContent = '0';
                    document.getElementById('total-photos').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading submission document:', error);
                // On error, keep the map empty instead of showing demo data
                clearMapMarkers();
                try { document.getElementById('timeline').innerHTML = ''; } catch (e) {}
                try { document.getElementById('total-stops').textContent = '0'; } catch (e) {}
                try { document.getElementById('total-photos').textContent = '0'; } catch (e) {}
            }
        }

        // Render submission document data (places array) on map and timeline
    async function renderSubmissionData(docData) {
            try {
                // Clear existing markers and timeline
                clearMapMarkers();
                const timeline = document.getElementById('timeline');
                timeline.innerHTML = '';

                const places = docData.places || [];
                let totalPhotos = 0;

                places.forEach((place, index) => {
                    totalPhotos += place.photoCount || 0;
                    const lat = place.location.latitude;
                    const lng = place.location.longitude;
                    const marker = createMarkerFromPlace(place, index, places.length);
                    __markers.push(marker);

                    // Timeline entry
                    const time = new Date(place.submissionTime.iso || place.submissionTime);
                    const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    let markerClass = 'checkpoint';
                    let statusIcon = '�';
                    let statusText = 'Meeting';
                    if (index === 0) { markerClass = 'start'; statusIcon = '🟢'; statusText = 'Sign in'; }
                    else if (index === places.length - 1) { markerClass = 'end'; statusIcon = '🔴'; statusText = 'Sign out'; }

                    const timelineItem = `
                        <div class="timeline-item">
                            <div class="timeline-marker ${markerClass}">${index + 1}</div>
                            <div class="timeline-content">
                                <h4>${statusIcon} ${statusText} at ${timeString}</h4>
                                <p><strong>${place.location.landmark}</strong></p>
                                <p>${place.location.addressDetail}</p>
                                <p style="color: #3498db;">📸 ${place.photoCount || 0} photo(s) taken</p>
                            </div>
                        </div>
                    `;
                    timeline.innerHTML += timelineItem;
                });

                document.getElementById('total-stops').textContent = places.length;
                document.getElementById('total-photos').textContent = totalPhotos;

                // Fit map to markers
                // Draw route following roads (using OSRM) when possible, fallback to straight polyline
                try {
                    const latlngs = places
                        .map(p => [p.location.latitude, p.location.longitude])
                        .filter(coord => coord[0] !== undefined && coord[1] !== undefined && !isNaN(coord[0]) && !isNaN(coord[1]));

                    let routeCoords = latlngs;
                    if (latlngs.length > 1) {
                        // Try to build a routed path along roads; falls back to straight lines on failure
                        try {
                            routeCoords = await buildRouteAlongRoads(latlngs);
                        } catch (e) {
                            console.warn('Routing service failed, falling back to straight lines:', e);
                            routeCoords = latlngs;
                        }

                        __routePolyline = L.polyline(routeCoords, { color: '#3388ff', weight: 4, opacity: 0.85 }).addTo(window.map);
                    }

                    if (__markers.length > 0) {
                        const groupItems = __markers.slice();
                        if (__routePolyline) groupItems.push(__routePolyline);
                        const group = new L.featureGroup(groupItems);
                        window.map.fitBounds(group.getBounds().pad(0.1));
                    }
                } catch (e) {
                    console.warn('Failed to draw route polyline:', e);
                }
            } catch (error) {
                console.error('Error rendering submission data:', error);
            }
        }

        // Create a marker from a place object and return the marker
        function createMarkerFromPlace(place, index, total) {
            const lat = place.location.latitude || 0;
            const lng = place.location.longitude || 0;
            let markerColor = '#3498db';
            if (index === 0) markerColor = '#2ecc71';
            if (index === total - 1) markerColor = '#e74c3c';

            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="width:25px;height:25px;border-radius:50%;background:${markerColor};border:3px solid white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;color:white;">${index+1}</div>`,
                    iconSize: [25, 25],
                    iconAnchor: [12, 12]
                })
            }).addTo(window.map);

            const dateTime = new Date(place.submissionTime.iso || place.submissionTime).toLocaleString();
            const popupContent = `
                <div style="max-width:250px;">
                    <h4 style="margin:0 0 10px 0;color:#333;">Stop #${index+1}</h4>
                    <p style="margin:5px 0;"><strong>Address:</strong><br>${place.location.addressDetail || ''}</p>
                    <p style="margin:5px 0;"><strong>Landmark:</strong> ${place.location.landmark || ''}</p>
                    <p style="margin:5px 0;"><strong>Time:</strong> ${dateTime}</p>
                    <p style="margin:5px 0; color:${markerColor}; font-weight:bold;">${index===0? '🟢 START' : index===total-1? '🔴 END' : '🔵 CHECKPOINT'}</p>
                </div>
            `;
            marker.bindPopup(popupContent);
            return marker;
        }

        function clearMapMarkers() {
            if (!__markers) return;
            __markers.forEach(m => {
                try { window.map.removeLayer(m); } catch (e) {}
            });
            __markers = [];
            // remove existing route polyline if any
            try {
                if (__routePolyline) {
                    window.map.removeLayer(__routePolyline);
                    __routePolyline = null;
                }
            } catch (e) {}
        }

        // Fallback: render static JSON file locations (existing behaviour)
        async function renderFallbackJSONData() {
            try {
                clearMapMarkers();
                const resp = await fetch('./bhubaneswar_block_data.json');
                const jsonData = await resp.json();
                const data = jsonData.data || [];
                const sortedData = data.slice().sort((a,b)=> new Date(a.dateTime) - new Date(b.dateTime));

                // create markers and timeline similar to earlier implementation
                const timeline = document.getElementById('timeline');
                timeline.innerHTML = '';
                let totalPhotos = 0;
                const markers = [];
                sortedData.forEach((location, index) => {
                    const lat = location.latitude;
                    const lng = location.longitude === 20.296059 && location.id === 1 ? 85.824500 : location.longitude;
                    let markerColor = '#3498db';
                    if (index === 0) markerColor = '#2ecc71';
                    if (index === sortedData.length - 1) markerColor = '#e74c3c';

                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="width:25px;height:25px;border-radius:50%;background:${markerColor};border:3px solid white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;color:white;">${index+1}</div>`,
                            iconSize: [25,25],
                            iconAnchor: [12,12]
                        })
                    }).addTo(window.map);
                    markers.push(marker);
                    __markers.push(marker);

                    totalPhotos += (location.photos && location.photos.length) || 0;

                    const time = new Date(location.dateTime);
                    const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const timelineItem = `
                        <div class="timeline-item">
                            <div class="timeline-marker checkpoint">${index+1}</div>
                            <div class="timeline-content">
                                <h4>📍 Meeting at ${timeString}</h4>
                                <p><strong>${location.landmark}</strong></p>
                                <p>${location.addressDetail}</p>
                                <p style="color: #3498db;">📸 ${(location.photos && location.photos.length) || 0} photo(s) taken</p>
                            </div>
                        </div>
                    `;
                    timeline.innerHTML += timelineItem;
                });

                document.getElementById('total-stops').textContent = sortedData.length;
                document.getElementById('total-photos').textContent = totalPhotos;

                if (markers.length > 0) {
                    // draw route connecting fallback markers using routing service where possible
                    try {
                        const latlngs = sortedData.map(loc => {
                            const lat = loc.latitude;
                            const lng = loc.longitude === 20.296059 && loc.id === 1 ? 85.824500 : loc.longitude;
                            return [lat, lng];
                        }).filter(c => c[0] !== undefined && c[1] !== undefined && !isNaN(c[0]) && !isNaN(c[1]));

                        if (latlngs.length > 1) {
                            try {
                                const routeCoords = await buildRouteAlongRoads(latlngs);
                                __routePolyline = L.polyline(routeCoords, { color: '#3388ff', weight: 4, opacity: 0.85 }).addTo(window.map);
                            } catch (err) {
                                // fallback to straight polyline if routing fails
                                __routePolyline = L.polyline(latlngs, { color: '#3388ff', weight: 4, opacity: 0.85 }).addTo(window.map);
                            }
                        }
                    } catch (e) {
                        console.warn('Failed to draw fallback route polyline:', e);
                    }

                    const group = new L.featureGroup(markers.concat(__routePolyline || []));
                    window.map.fitBounds(group.getBounds().pad(0.1));
                }
            } catch (error) {
                console.error('Error loading fallback JSON data:', error);
            }
        }

        // Build a routed path along roads using OSRM routing service.
        // Accepts an array of [lat, lng] coordinates and returns an array of [lat, lng]
        // coordinates following roads. Falls back to input coords on failure.
        async function buildRouteAlongRoads(latlngs) {
            if (!latlngs || latlngs.length < 2) return latlngs;
            // Helper to request OSRM for a set of coordinates (lon,lat pairs joined by ; )
            const fetchOSRM = async (coordsStr) => {
                const url = `https://router.project-osrm.org/route/v1/driving/${coordsStr}?overview=full&geometries=geojson`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('OSRM request failed ' + res.status);
                const json = await res.json();
                if (!json.routes || !json.routes.length) throw new Error('No routes in OSRM response');
                return json.routes[0].geometry.coordinates.map(c => [c[1], c[0]]); // convert [lon,lat] -> [lat,lon]
            };

            try {
                // If there are not too many waypoints, request a single route
                if (latlngs.length <= 10) {
                    const coordsStr = latlngs.map(c => `${c[1]},${c[0]}`).join(';');
                    return await fetchOSRM(coordsStr);
                }

                // For larger lists, build the route piecewise between consecutive points to avoid OSRM limits
                let full = [];
                for (let i = 0; i < latlngs.length - 1; i++) {
                    const a = latlngs[i];
                    const b = latlngs[i + 1];
                    const coordsStr = `${a[1]},${a[0]};${b[1]},${b[0]}`;
                    try {
                        const seg = await fetchOSRM(coordsStr);
                        if (seg && seg.length) {
                            if (full.length) {
                                // avoid duplicating the connecting point
                                full = full.concat(seg.slice(1));
                            } else {
                                full = full.concat(seg);
                            }
                        }
                    } catch (e) {
                        console.warn('OSRM segment failed for', a, b, e);
                    }
                }
                if (full.length) return full;
            } catch (e) {
                console.warn('Routing failed:', e);
            }
            // fallback
            return latlngs;
        }
    </script>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</body>
</html> 